<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8" />
        <meta http-equiv="Cache-Control" content="no-cache,no-store,must-revalidate"/><meta http-equiv="Pragma" content="no-cache"/><meta http-equiv="Expires" content="0"/>
        <title>Phony-Mote</title>
    </head>
    <body class="bg-dark text-white">
<style>
body{
    overscroll-behavior: auto;
}

.icon{
	width: 50px;
	height: 50px;
	font-size:50px!important;
    color: white;
}
.cinemabar{
    display:flex;margin-top:10px;
        background: black;
}
#qr{
	margin-left:25%;
	width: 50%;
    padding: 20px;
}
#mousefield{
    position:absolute;touch-action:auto;
}

.flex-auto{
flex:auto;
width:30%;
margin: 1px;
height: 80px;
}

.checkbox{
width:50px;
height:50px;
}

#containerscreenshot{
border: red solid;
border-width: 2px 0px 2px 0px;
background:beige;
    position: relative;
}
.imgscreenshot{
    position: absolute;
}

</style>
<script type="text/javascript" src="/static/jquery-3.4.1.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/socket.io/2.2.0/socket.io.js" integrity="sha256-yr4fRk/GU1ehYJPAs8P4JlTgu0Hdsp4ZKrx8bDEDC3I=" crossorigin="anonymous"></script>

<script type="text/javascript">

const simulate = (keyval)=>{
    const data = {key: keyval}
    fetch("/simulate",{
        headers: { "Content-Type": "application/json; charset=utf-8" },
        method: "POST",
        body: JSON.stringify(data) 
    }).then(res => {console.log("Request complete! response:", res)})
    return
} 


const enterText = ()=>{
    const text = $("#keyboardtext").val();
    const data = {text: text}
    fetch("/text",{
        headers: { "Content-Type": "application/json; charset=utf-8" },
        method: "POST",
        body: JSON.stringify(data) 
    }).then(res => {console.log("Request complete! response:", res);setTimeout( function(){screenshot()}, 100 );
    })
    return
} 

const copy = ()=>{
    fetch("/copy",{
        headers: { "Content-Type": "application/json; charset=utf-8" },
        method: "GET",
    }).then(res => {console.log("Request complete! response:", res);
    })
    return
}
const store = ()=>{
    fetch("/store",{
        headers: { "Content-Type": "application/json; charset=utf-8" },
        method: "GET",
    }).then(res => {console.log("Request complete! response:", res);
    })
    return
}
const visit = (link)=>{
    const data = {link: link}
    console.log(data)
    fetch("/visit",{
            headers: { "Content-Type": "application/json; charset=utf-8" },
            method: "POST",
            body: JSON.stringify(data) 
        }).then(res => {console.log("Request complete! response:", res);
        })
        return
}
const del_bmark = (id)=>{
    const data = {id: id}
    console.log(data)
    fetch("/del",{
            headers: { "Content-Type": "application/json; charset=utf-8" },
            method: "POST",
            body: JSON.stringify(data) 
        }).then(res => {console.log("Request complete! response:", res);
        })
    return
}
const click = (pos_x,pos_y)=>{
    const data = {posx: pos_x, posy: pos_y}
    fetch("/click",{
        headers: { "Content-Type": "application/json; charset=utf-8" },
        method: "POST",
        body: JSON.stringify(data) 
    }).then(res => {
        console.log("[click] executed");
        setTimeout( function(){screenshot()}, 500 )
        setTimeout( function(){screenshot()}, 2000 )
    })
    return
} 

const scroll = (v,h)=>{
    const data = {vertical: (v*20/(imgheight)).toFixed(0), horizontal: (h*20/(imgwidth*2)).toFixed(0)}
    fetch("/scroll",{
        headers: { "Content-Type": "application/json; charset=utf-8" },
        method: "POST",
        body: JSON.stringify(data) 
    }).then(res => {
        console.log(res)
        //setTimeout( function(){screenshot()}, 0 )
    })
    return
} 

const stream = (rate) => {

    socket.emit('stream', rate);

    fetch("/stream",{
        headers: { "Content-Type": "application/json; charset=utf-8" },
        method: "GET",
    }).then(
        res => {
            return res;
        }).then((data)=>{console.log(data)})
}

const screenshot = () => {
    fetch("/shot",{
        headers: { "Content-Type": "application/json; charset=utf-8" },
        method: "GET",
    }).then(
        res => {
            //const ctx_img  = document.getElementById("imgscreenshot")
            //ctx_img.src="/static/shot.png?random="+new Date().getTime();

            const img  = $("#imgscreenshot0");
            const img2 = $("#imgscreenshot1");

            let selected = null;
            let unselected = null;

            if (img.css("display") == "none" ){
                selected = img;
                unselected = img2;
            }else{
                selected = img2;
                unselected = img;
            }

                selected[0].src = "/static/shot.jpeg?random="+new Date().getTime();
            //img.onload = () => { $("#myCanvas")[0].getContext("2d").drawImage(img, 0,0,imgwidth,imgheight); console.log("[canvas] draw");}
            selected[0].onload = () => { selected.css("display", "block"); unselected.css("display","none");}

        })
        return
}
var updateInterval = 0;

const toggleStream2 = (cb) => {
    if (cb.checked === true){
        updateRate = parseInt($("#updaterate")[0].value);

        updateRate = Number.isInteger(updateRate) && updateRate >= 1 ? updateRate : 500;

        updateInterval = setInterval(()=>{screenshot()}, updateRate);
    }else{
        clearInterval(updateInterval);
    }
}


var imgwidth = 0;
var imgheight = 0;

var keyboardOn = 0;
const toggleKeyboard = ()=>{
    if ( $( "#keyboard" ).is( ":hidden" ) ) {
        $( "#keyboard" ).slideDown( "fast" );
    } else {
        $( "#keyboard" ).slideUp("fast");
    }
}

var socket = io();
socket.on('connect', function() {
        socket.emit('my event', {data: 'I\'m connected!'});
});

var last_request = Date.now();

var imgqueue = [];
var bufferPTR  = 0;
var displayPTR = 0;
var displayTimestamp = Date.now();
var renderTimestamp = Date.now();

function renderLoop(){

    renderTimestamp = Date.now();

    if (updateRate == 0){return}

    const lag = last_request - displayTimestamp;

    //$('#mouseh3')[0].innerText = ("lag " + lag);
    console.log("lag"+lag)

    let nextPTR = (displayPTR + 1) % imgqueue.length;
    

    if (imgqueue[nextPTR].complete && imgqueue[nextPTR].timestamp > displayTimestamp ){
        imgqueue[displayPTR].style.display = "none";
        imgqueue[nextPTR].style.display = "block";
        displayTimestamp = imgqueue[nextPTR].timestamp;

        console.log("D: " + nextPTR);
        displayPTR = nextPTR;

        const factor = 1/(lag/(updateRate*4)+1)

        timeLeft = updateRate - (Date.now() - renderTimestamp);
        setTimeout( renderLoop, timeLeft > 0 ? timeLeft*factor : 0 )
    }else{
        setTimeout( renderLoop, updateRate*0.1 )
    }
}

var updateRate = 0;

const toggleStream = (cb) => {
    console.log("stream " + cb.checked);

    if (cb.checked){
        updateRate = parseInt($("#updaterate")[0].value);
        bufferPTR  = 0;
        displayPTR = 0;
        last_request = Date.now();
        stream(updateRate);

        renderLoop();
    }else{
        updateRate = 0;
        stream(0);
    }
}

socket.on('image', function(data){

    let img_str = new TextDecoder().decode(data);

    bufferPTR = (bufferPTR + 1) % imgqueue.length;

    console.log("B: " + bufferPTR);
    imgqueue[bufferPTR].timestamp = Date.now();
    last_request = imgqueue[bufferPTR].timestamp;
    imgqueue[bufferPTR].src = 'data:image/jpeg;base64,' + img_str;
    const t1 = Date.now();
    //img.onload = () => { $("#myCanvas")[0].getContext("2d").drawImage(img, 0,0,imgwidth,imgheight); console.log("[canvas] draw");}
    //$("#myCanvas")[0].getContext("2d").drawImage(img, 0,0,imgwidth,imgheight);
    console.log("[canvas] draw");
});

var last_scroll = Date.now();


$(document).ready(function() {

    fetch("/bmarks",{
        headers: { "Content-Type": "application/json; charset=utf-8" },
        method: "GET",
    }).then(res => {
        console.log("Request complete! response:", res);
        return res.json();
    }).then(data => {
        console.log(data.bookmarks);
        var i;
        for (i=0; i<data.bookmarks.length; ++i){
            $("#bookmark-list").append("<li class='bookmark list-group-item list-group-item-secondary' link='"+data.bookmarks[i]+"' class='list-group-item list-group-item-secondary'>" + data.bookmarks[i] + "<i id="+i+" style='float:right' class='del-bmark material-icons'>delete</i></li>")
        }
        $(".bookmark").click(function(){ 
            visit($(this).attr("link"))
        })
        $(".del-bmark").click(function(){ 
            del_bmark($(this).attr("id"));
            $(this).parent().remove();
        })


    });




    var i;
    for ( i = 0; i < 10; i++){
        let imgelement = document.getElementById("imgscreenshot" + i + "");
        imgelement.idx = i;
        imgelement.displayTimestamp = Date.now();
        imgqueue.push(imgelement);
    }

    $('#combobox1').combobox();

    var lastClick = Date.now();
    var x = 0;
    var y = 0;
    const minClickInterval = 0.5;
    $("#keyboardtext").on('keyup', function (e) {
        const text = $("#keyboardtext")[0].value
            console.log($("#keyboardtext")[0].value)
            if (e.keyCode === 13) {
                //$("#keyboardtext")
                simulate("Return")
            }else if(e.keyCode === 8){
                simulate("BackSpace")
            }else{
                simulate(text[text.length - 1])
            }
    });

    imgwidth = $('#imgscreenshot0')[0].width;
    imgheight = $('#imgscreenshot0')[0].height+4;

    window.innerWidth
        $('.cinemabar').css("width", imgwidth + "px")
        $('.cinemabar').css("height", (imgheight) +"px")

        $('#containerscreenshot').css('width', imgwidth + 'px');
    $('#containerscreenshot').css('height', imgheight + 'px');
    $('#mousefield').css('width', imgwidth + 'px');
    $('#mousefield').css('height', imgheight + 'px');

    $('#mouseh3')[0].innerText = imgheight;


    $('#myCanvas').attr("width" ,imgwidth + 'px');
    $('#myCanvas').attr("height", imgheight + 'px');

    var scrolling = false;
    var mousemove = false;
    var mouse_x = -1;
    var mouse_y = -1;

    $("#scrollbar").on("touchstart mousedown", function(event) {
        event.preventDefault()
            mousemove = true;

        if (event.originalEvent.touches){
            touch = event.originalEvent.touches[0]
                mouse_x = touch.pageX
                mouse_y = touch.pageY
        }else{
            mouse_x = event.pageX;
            mouse_y = event.pageY;
        }

        $('#mouseh3')[0].innerText = ("mdown " + mouse_x);
    });
    $("#scrollbar").on("touchend mouseup", function(event) {

        if (!mousemove){return}

        event.preventDefault()
            let pos_x = mouse_x;
        let pos_y = mouse_y;

        if (event.changedTouches){
            touch = event.changedTouches[0]
                pos_x = touch.pageX
                pos_y = touch.pageY
        }else{
            pos_x = event.pageX;
            pos_y = event.pageY;
        }

        const move_x = pos_x - mouse_x;
        const move_y = pos_y - mouse_y;

        mouse_x = pos_x;
        mouse_y = pos_y;
        $('#mouseh3')[0].innerText = ("mup " + pos_y);
        //scroll(-move_y, 0);

        console.log(move_x + ";" + move_y);
        mousemove = false; 
        //$('#mouseh3')[0].innerText = ("mup " + move_y);
    });

    $("#scrollbar").on("touchmove mousemove", function(event) {
        if (!mousemove) {return}
        event.preventDefault();

        if (Date.now() - last_scroll < 200){
            return;
        }

        let pos_x = mouse_x;
        let pos_y = mouse_y;

        if (event.changedTouches){
            touch = event.changedTouches[0]
                pos_x = touch.pageX
                pos_y = touch.pageY
        }else{
            pos_x = event.pageX;
            pos_y = event.pageY;
        }
        const move_x = pos_x - mouse_x;
        const move_y = pos_y - mouse_y;

        if(Math.abs(move_x) > 5 || Math.abs(move_y) > 5){

            console.log("touchmove");
            scroll(move_y, 0);
            screenshot();
            last_scroll = Date.now();

            mouse_x = pos_x;
            mouse_y = pos_y;

            $('#mouseh3')[0].innerText = ("move_y" + move_y);
        }

    });


    $("#mousefield").on("touchstart mousedown", function(event) {
        x = event.pageX - $('#containerscreenshot')[0].offsetLeft;
        y = event.pageY - $('#containerscreenshot')[0].offsetTop;
        console.log("mdown" + x + ";" + y)
            lastClick = Date.now();
        mousemove = true;
        setTimeout(function(){
            if (mousemove) {
                scrolling=true;
                mouse_x = 0;
                mouse_y = 0;

                $("body").css("overscroll-behavior", "none");
            }
        }, 200)
    });
    $("#mousefield").on("touchmove mousemove", function(event) {

        if ( scrolling ){
            event.preventDefault();
            $('#mouseh3')[0].innerText = ("they see me scrolling");
            mousemove = true;
            $("#mousefield").css("touch-action", "none");

            if (Date.now() - last_scroll < 200){
                return;
            }

            let pos_x = mouse_x;
            let pos_y = mouse_y;

            if (event.changedTouches){
                touch = event.changedTouches[0]
                    pos_x = touch.pageX
                    pos_y = touch.pageY
            }else{
                pos_x = event.pageX;
                pos_y = event.pageY;
            }

            if ( (!mouse_x) && (!mouse_y) ){
                mouse_x = pos_x;
                mouse_y = pos_y;
            }

            const move_x = pos_x - mouse_x;
            const move_y = pos_y - mouse_y;

            if(Math.abs(move_x) > 5 || Math.abs(move_y) > 5){

                console.log("touchmove");
                scroll(move_y, -move_x);
                screenshot();
                last_scroll = Date.now();

                mouse_x = pos_x;
                mouse_y = pos_y;

                $('#mouseh3')[0].innerText = ("move_y" + move_y);
            }
        }else{
            $('#mouseh3')[0].innerText = ("nope");
        }
    })
    $("#mousefield").on("touchend mouseup", function(event) {
        console.log("mup");
        scrolling = false;
        $("#mousefield").css("touch-action", "auto");
        $("body").css("overscroll-behavior", "auto");

        mousemove = false;

        if (((Date.now() - lastClick) / 1000) < minClickInterval){
            click(x,y);
        }
    });
});
</script>


<link rel="stylesheet" href="/static/bootstrap.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

<link rel="stylesheet" href="/static/bootstrap-combobox.css">
<script type="text/javascript" src="/static/bootstrap-combobox.js"></script>

<div class="wrapper">
    <ul class="nav nav-tabs" style="display:flex">
        <!-- add data-toggle attribute to the anchors -->
        <li class="active" style="flex:auto"><a data-toggle="tab" href="#home"><i class="material-icons icon">home</i></a></li>
        <li style="flex:auto"><a data-toggle="tab" href="#youtube"><img src="/static/youtube.png" class="icon" alt="Italian Trulli"></a></li>
        <li style="flex:auto"><a data-toggle="tab" href="#netflix"><img src="/static/netflix.png" class="icon" alt="Italian Trulli"></a></li>
        <li style="flex:auto"><a data-toggle="tab" href="#mouse" onclick="screenshot()"><i class="material-icons icon">desktop_windows</i></a></li>
        <li style="flex:auto"><a onclick="toggleKeyboard()" data-toggle="tab" href="#"><i class="material-icons icon">keyboard</i></a></li>
    </ul>
    <div id="keyboard" style="display:none">
        <h3>Keyboard</h3>
        <div class="input-group mb-3">
            <input onsubmit="enterText()" id="keyboardtext" type="text" class="form-control" placeholder="Link" aria-label="Link" aria-describedby="button-addon2">
            <div class="input-group-append">
                <button 
                 onclick="enterText()"
                 class="btn btn-outline-secondary" type="button" id="button-addon2"><i class="material-icons icon">search</i></button>
                <button 
                                                                                       onclick="copy()"
                                                                                       class="btn btn-outline-secondary" type="button" id="button-addon2"><i class="material-icons icon">file_copy</i></button>
                <button 
                                                                                                                                                             onclick="store()"
                                                                                                                                                             class="btn btn-outline-secondary" type="button" id="button-addon2"><i class="material-icons icon">save</i></button>

            </div>
        </div>
    </div>

    <div class="tab-content">
        <div id="home" class="tab-pane active">
            <h3>QR</h3>
            <img src="/static/qr.jpeg" id="qr" alt="Italian Trulli">
            <ul class="list-group" id="bookmark-list">
            </ul>
        </div>
        <div id="youtube" class="tab-pane fade">
            <h3>Youtube</h3>
            <div class="row" style="display:flex;align-items:center">
                <button class="btn btn-danger flex-auto" onclick="simulate('j')">J</button>
                <button class="btn btn-danger flex-auto" onclick="simulate('up')">UP</button>
                <button class="btn btn-danger flex-auto" onclick="simulate('k')">K</button>
            </div>
            <div class="row" style="display:flex;align-items:center">

                <button class="btn btn-danger flex-auto" onclick="simulate('left')">left</button>
                <button class="btn btn-danger flex-auto" onclick="simulate('down')">down</button>
                <button class="btn btn-danger flex-auto" onclick="simulate('right')">right</button>
            </div>
            <div class="row" style="display:flex;align-items:center">

                <button class="btn btn-danger flex-auto" onclick="simulate('space')">space</button>
                <button class="btn btn-danger flex-auto" onclick="simulate('m')">mute</button>
                <button class="btn btn-danger flex-auto" onclick="simulate('f')">full</button>
                <button class="btn btn-danger flex-auto" onclick="simulate('Escape')">ESC</button>
            </div>
        </div>
        <div id="netflix" class="tab-pane fade">
            <h3>Netflix</h3>
            <div class="row" style="display:flex;align-items:center">

                <button class="btn btn-danger flex-auto" onclick="simulate('j')" disabled>J</button>
                <button class="btn btn-danger flex-auto" onclick="simulate('up')">UP</button>
                <button class="btn btn-danger flex-auto" onclick="simulate('l')" disabled>K</button>
            </div>
            <div class="row" style="display:flex;align-items:center">

                <button class="btn btn-danger flex-auto" onclick="simulate('left')">left</button>
                <button class="btn btn-danger flex-auto" onclick="simulate('down')">down</button>
                <button class="btn btn-danger flex-auto" onclick="simulate('right')">right</button>
            </div>
            <div class="row" style="display:flex;align-items:center">

                <button class="btn btn-danger flex-auto" onclick="simulate('space')">space</button>
                <button class="btn btn-danger flex-auto" onclick="simulate('m')">mute</button>
                <button class="btn btn-danger flex-auto" onclick="simulate('f')">full</button>
                <button class="btn btn-danger flex-auto" onclick="simulate('Escape')">ESC</button>
            </div>
        </div>

        <div id="mouse" class="tab-pane fade">
            <h3 id="mouseh3">Mouse</h3>
            <div style="display:flex;align-items:center">
                <div>
                    <input onclick="toggleStream(this)" class="checkbox" type="checkbox" aria-label="Checkbox for following text input">
                </div>

                <div style="font-size:30px;margin-left:50px;">
                    Streaming (<input id="updaterate" class="bg-dark text-white" type="text"/>)
                    )
                </div>
                <div style="font-size:30px;margin-left:50px;">
                    <button onclick="screenshot()" class="btn btn-success"><i class="material-icons">refresh</i></button>
                </div>
            </div>

            <div class="cinemabar">

                <div id="scrollbar" style="width:100px;display:flex;justify-content: center;align-items:center;background:darkcyan;"><i class="material-icons">unfold_more</i></div>

                <div id="containerscreenshot">
                    <img src="/static/shot.jpeg" class="imgscreenshot" style="display:none" id="imgscreenshot0" alt="Screenshot">      
                    <img src="/static/shot.jpeg" class="imgscreenshot" style="display:none" id="imgscreenshot1" alt="Screenshot">      
                    <img src="/static/shot.jpeg" class="imgscreenshot" style="display:none" id="imgscreenshot2" alt="Screenshot">      
                    <img src="/static/shot.jpeg" class="imgscreenshot" style="display:none" id="imgscreenshot3" alt="Screenshot">      
                    <img src="/static/shot.jpeg" class="imgscreenshot" style="display:none" id="imgscreenshot4" alt="Screenshot">      
                    <img src="/static/shot.jpeg" class="imgscreenshot" style="display:none" id="imgscreenshot5" alt="Screenshot">      
                    <img src="/static/shot.jpeg" class="imgscreenshot" style="display:none" id="imgscreenshot6" alt="Screenshot">      
                    <img src="/static/shot.jpeg" class="imgscreenshot" style="display:none" id="imgscreenshot7" alt="Screenshot">      
                    <img src="/static/shot.jpeg" class="imgscreenshot" style="display:none" id="imgscreenshot8" alt="Screenshot">      
                    <img src="/static/shot.jpeg" class="imgscreenshot" style="display:none" id="imgscreenshot9" alt="Screenshot">      
                    <div id="mousefield"></div>
                </div>
            </div>

        </div>
    </div>
</div>
    </body>
</html>
